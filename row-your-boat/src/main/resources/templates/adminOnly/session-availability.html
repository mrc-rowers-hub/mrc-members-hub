<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Home</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <link rel="stylesheet" th:href="@{/sidebar.css}">
    <style>
        /* NEW: styles for draggable rower boxes */
        #rowersContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .rower-box {
            padding: 0.4rem 0.75rem;
            background-color: #d0e7ff;
            border: 1px solid #3399ff;
            border-radius: 4px;
            cursor: grab;
            user-select: none;
        }
        .rower-box:active {
            cursor: grabbing;
        }

        .rower-box.assigned {
            background-color: #ccc !important;
            color: #666 !important;
            border-color: #999 !important;
            cursor: default !important;
            user-select: none;
            opacity: 0.6;
            pointer-events: none; /* Prevent any interaction */
        }

        /* Drop boxes styling */
        .drop-box {
            width: 150px;
            height: 30px;
            border: 1px dashed #888;
            border-radius: 4px;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
<header>
    <div class="header-container">
        <div class="header-content">
            <h1>MRC Rowing Services</h1>
            <img src="/mrc_logo.png" alt="MRC Logo" width="100">
        </div>
    </div>
</header>

<!-- Include the sidebar -->
<div th:replace="~{sections/sidebar :: sidebarFragment}"></div>

<main class="content" id="content">
    <h2>Session Availability</h2>

    <div style="display: flex; align-items: flex-start; gap: 3rem; margin-bottom: 2rem;">

        <!-- Left: Session info + Rowers -->
        <div style="min-width: 250px;">
            <h2>Session Availability</h2>
            <div class="session-info" style="margin-bottom: 1rem;">
                <p><strong>Date:</strong> <span th:text="${sessionDate}"></span></p>
                <p><strong>Time:</strong> <span th:text="${sessionStartTime}"></span> to <span th:text="${sessionEndTime}"></span></p>
            </div>

            <!-- REPLACED the rowers table with draggable rower boxes -->
            <div id="rowersContainer" th:if="${availabilities != null}">
                <div class="rower-box" draggable="true" th:each="rower : ${availabilities}" th:text="${rower}"></div>
            </div>

        </div>

        <!-- Right: Boats Available -->
        <div style="flex: 1;">
            <h3>Boats Available</h3>
            <ul id="boatList" th:if="${boatsAvailable != null}"
                style="list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 0.75rem;">
                <li th:each="boat : ${boatsAvailable}"
                    th:attr="data-name=${boat.name}, data-type=${boat.boatType}, data-capacity=${boat.capacity}"
                    onclick="selectBoat(this)"
                    style="border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 4px; background: #f9f9f9;
                           cursor: pointer; flex: 1 1 120px; max-width: 150px; text-align: center;
                           box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <span th:text="${boat.name}"></span>
                </li>
            </ul>
        </div>

    </div>
    <hr>

    <div id="selectedBoatContainer" style="display: flex; gap: 2rem; flex-wrap: nowrap; align-items: flex-start; border-left: 1px solid #ddd; padding-left: 1rem; padding-right: 2rem;">
        <div id="boatInfo" style="min-width: 180px; max-width: 250px;">
            <strong>Selected Boat:</strong>
            <p id="selectedBoatName" style="font-weight: bold; margin-top: 0.25rem;"></p>
            <p id="selectedBoatType" style="color: #666; margin: 0.25rem 0;"></p>
            <p id="selectedBoatCapacity" style="color: #666; margin: 0.25rem 0;"></p>
        </div>

        <div id="boatDiagram" style="margin-top: 0; flex-grow: 1; display: flex; justify-content: flex-end;"></div>

    </div>

    <h3>Blades Available</h3>
    <ul th:if="${bladesAvailable != null}" th:each="blade : ${bladesAvailable}">
        <li th:text="${blade.name}"></li>
    </ul>

    <div class="form-container">
        <button class="submit-button" onclick="window.location.href='/make-weekly-plan'">Back to Make Weekly Plans</button>
    </div>

</main>

<footer>
    <p>Data provided by <strong>OpenWeatherMap</strong></p>
    <p>Logic/weather rules, & website, provided by Mersey Rowing Club</p>
</footer>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var sidebarToggle = document.getElementById("sidebarToggle");
        var sidebar = document.getElementById("sidebar");
        var content = document.getElementById("content");

        if (sidebarToggle && sidebar && content) {
            sidebarToggle.addEventListener("click", function() {
                sidebar.classList.toggle("collapsed");
                content.classList.toggle("collapsed");
                this.classList.toggle("collapsed");
            });
        }

        var boatsBladesToggle = document.getElementById('boatsBladesToggle');
        var boatsBladesSubmenu = document.getElementById('boatsBladesSubmenu');

        boatsBladesToggle.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default link behavior
            boatsBladesSubmenu.style.display = (boatsBladesSubmenu.style.display === 'block') ? 'none' : 'block';
        });

        // Drag and drop handlers for rower boxes and boat drop boxes
        const rowers = document.querySelectorAll('.rower-box');
        rowers.forEach(rower => {
            rower.addEventListener('dragstart', (e) => {
                if (rower.classList.contains('assigned')) {
                    e.preventDefault(); // Don't allow dragging if assigned
                    return;
                }
                e.dataTransfer.setData('text/plain', rower.textContent);
            });
        });

        const boatDiagram = document.getElementById('boatDiagram');

        boatDiagram.addEventListener('dragover', (e) => {
            if (e.target.classList.contains('drop-box')) {
                e.preventDefault(); // Allow drop
                e.target.style.backgroundColor = '#def'; // Highlight drop box
            }
        });

        boatDiagram.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('drop-box')) {
                e.target.style.backgroundColor = '#fff'; // Remove highlight
            }
        });

        boatDiagram.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.target.classList.contains('drop-box')) {
                // Only allow drop if drop-box is empty or contains placeholder text
                if (e.target.textContent !== '' && e.target.textContent !== 'Drop rower') {
                    // Already assigned, ignore the drop
                    return;
                }

                const rowerName = e.dataTransfer.getData('text/plain');

                // Prevent assigning the same rower twice:
                const assignedRower = Array.from(document.querySelectorAll('.rower-box.assigned')).find(
                    box => box.textContent === rowerName
                );
                if (assignedRower) {
                    // Already assigned elsewhere, ignore the drop
                    return;
                }

                // Assign rower to drop box
                e.target.textContent = rowerName;
                e.target.style.backgroundColor = '#cfc'; // Mark as filled

                // Mark rower as assigned and disable dragging
                const rowerBox = Array.from(document.querySelectorAll('.rower-box')).find(
                    box => box.textContent === rowerName && !box.classList.contains('assigned')
                );
                if (rowerBox) {
                    rowerBox.classList.add('assigned');
                    rowerBox.setAttribute('draggable', 'false');
                }
            }
        });

        // Allow unassigning rowers by clicking on assigned drop boxes
        boatDiagram.addEventListener('click', (e) => {
            if (e.target.classList.contains('drop-box') && e.target.textContent !== 'Drop rower') {
                const rowerName = e.target.textContent;

                // Clear the drop box
                e.target.textContent = 'Drop rower';
                e.target.style.backgroundColor = '#fff';

                // Re-enable dragging on the assigned rower box
                const rowerBox = Array.from(document.querySelectorAll('.rower-box.assigned')).find(
                    box => box.textContent === rowerName
                );
                if (rowerBox) {
                    rowerBox.classList.remove('assigned');
                    rowerBox.setAttribute('draggable', 'true');
                }
            }
        });

    });

    function selectBoat(element) {
        // Reset styling
        document.querySelectorAll('#boatList li').forEach(li => {
            li.style.fontWeight = 'normal';
            li.style.backgroundColor = 'white';
        });

        // Highlight selected boat
        element.style.fontWeight = 'bold';
        element.style.backgroundColor = '#eef';

        // Extract info
        const boatName = element.getAttribute('data-name');
        const boatType = element.getAttribute('data-type');
        const boatCapacity = element.getAttribute('data-capacity');

        // Populate display
        document.getElementById('selectedBoatName').innerText = boatName;
        document.getElementById('selectedBoatType').innerText = `Type: ${boatType}`;
        document.getElementById('selectedBoatCapacity').innerText = `Capacity: ${boatCapacity}`;

        renderBoatDiagram(parseInt(boatCapacity));
    }

    function renderBoatDiagram(capacity) {
        const container = document.getElementById('boatDiagram');
        container.innerHTML = ''; // Clear previous diagram

        // Main horizontal wrapper: Drop boxes (left) + Boat (right)
        const mainWrapper = document.createElement('div');
        mainWrapper.style.display = 'flex';
        mainWrapper.style.alignItems = 'center';
        mainWrapper.style.gap = '1rem';

        // DROP BOXES: Left column
        const dropBoxColumn = document.createElement('div');
        dropBoxColumn.style.display = 'flex';
        dropBoxColumn.style.flexDirection = 'column';
        dropBoxColumn.style.gap = '0.5rem';

        // BOAT COLUMN: includes Bow label + boatShell + Stroke label
        const boatColumn = document.createElement('div');
        boatColumn.style.display = 'flex';
        boatColumn.style.flexDirection = 'column';
        boatColumn.style.alignItems = 'center';
        boatColumn.style.gap = '0.5rem';

        // Bow label
        const bowLabel = document.createElement('div');
        bowLabel.innerText = 'Bow';
        bowLabel.style.fontWeight = 'bold';
        bowLabel.style.color = '#444';

        // Boat shell with vertical seats
        const boatShell = document.createElement('div');
        boatShell.style.display = 'flex';
        boatShell.style.flexDirection = 'column';
        boatShell.style.gap = '0.5rem';
        boatShell.style.padding = '1rem';
        boatShell.style.border = '2px solid #333';
        boatShell.style.borderRadius = '999px';
        boatShell.style.background = '#f4f4f4';
        boatShell.style.alignItems = 'center';

        // Stroke label
        const strokeLabel = document.createElement('div');
        strokeLabel.innerText = 'Stroke';
        strokeLabel.style.fontWeight = 'bold';
        strokeLabel.style.color = '#444';

        for (let i = 0; i < capacity; i++) {
            // Create drop box
            const dropBox = document.createElement('div');
            dropBox.className = 'drop-box';
            dropBox.setAttribute('data-seat', i + 1);
            dropBox.innerText = 'Drop rower';
            dropBoxColumn.appendChild(dropBox);

            // Create seat
            const seat = document.createElement('div');
            seat.className = 'boat-seat';
            seat.style.width = '30px';
            seat.style.height = '30px';
            seat.style.borderRadius = '50%';
            seat.style.backgroundColor = '#bbb';
            seat.style.display = 'flex';
            seat.style.justifyContent = 'center';
            seat.style.alignItems = 'center';
            seat.style.userSelect = 'none';
            seat.innerText = i + 1;
            boatShell.appendChild(seat);
        }

        boatColumn.appendChild(bowLabel);
        boatColumn.appendChild(boatShell);
        boatColumn.appendChild(strokeLabel);

        mainWrapper.appendChild(dropBoxColumn);
        mainWrapper.appendChild(boatColumn);
        container.appendChild(mainWrapper);
    }
</script>
</body>
</html>
